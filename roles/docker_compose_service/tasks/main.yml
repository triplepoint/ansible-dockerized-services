---
- name: Ensure the service config directories on the host are present
  file:
    path: "{{ item.external }}"
    state: directory
    mode: 0755
  with_items: "{{ docker_service_config_dirs }}"
  notify: restart docker service

- name: Ensure any service configuration files are in place on the host
  template:
    src: "{{ item.1.template }}"
    dest: "{{ item.0.external }}/{{ item.1.dest }}"
    mode: 0600
  with_subelements:
    - "{{ docker_service_config_dirs }}"
    - templates
    - skip_missing: True
  notify: restart docker service

- name: Ensure the Docker-Compose template directory exists
  file:
    state: directory
    path: "{{ docker_service_compose_dir }}"
    mode: 0755

- name: Ensure this service's Docker-Compose template is present
  template:
    src: "{{ docker_service_compose_template }}"
    dest: "{{ docker_service_compose_dir }}/docker-compose.yml"

# - name: Ensure the latest images for the upstream container
#   community.docker.docker_image:
#     name: "{{ docker_service_parent_image }}"
#     source: pull
#     force_source: yes
#     tag: "{{ docker_service_parent_image_tag }}"
#   when: docker_service_parent_image

- name: Ensure the service container(s) is/are started
  docker_compose:
    project_src: "{{ docker_service_compose_dir }}"
    pull: yes
