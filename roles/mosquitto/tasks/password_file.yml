---
- name: Generate a hash of the users/passwords
  shell: 'echo -n "{{ mosquitto_users | to_json }}" | md5sum > /tmp/mosquitto_users_hash.new'
  register: _mosquitto_users_hash
  changed_when: False
  no_log: True

- name: Compare the hash to the hash of the last deploy
  command: "diff -q /tmp/mosquitto_users_hash.new /tmp/mosquitto_users_hash"
  register: _mosquitto_hashes_diff
  changed_when: False
  ignore_errors: True

- name: Set the variable flag for "the password file has changed"
  set_fact: _mosquitto_passwords_changed="{{ _mosquitto_hashes_diff.rc != 0 }}"

- name: Replace the hash file with the new one
  command: "mv /tmp/mosquitto_users_hash.new /tmp/mosquitto_users_hash"
  changed_when: False

- name: Delete the existing password file
  file: path="/etc/mosquitto/passwd" state=absent
  when: _mosquitto_passwords_changed

- name: Start with an empty password file
  file: path="/etc/mosquitto/passwd" state=touch
  when: _mosquitto_passwords_changed

- name: Write the temporary password file contents
  command: "docker run --rm -v /etc/mosquitto/passwd:/mosquitto/config/passwd eclipse-mosquitto:{{ mosquitto_docker_version }} mosquitto_passwd -b /mosquitto/config/passwd {{ item.name }} {{ item.password }}"
  with_items: "{{ mosquitto_users }}"
  when: _mosquitto_passwords_changed
  no_log: True
