---
- name: Ensure Docker-related python packages are present
  pip: name=docker

- name: Ensure the mosquitto directories are present on the host
  file: state=directory path="{{ item }}" mode=0777
  with_items:
    - "/etc/mosquitto"
    - "/opt/mosquitto/data"
    - "/var/log/mosquitto"

- name: Ensure the include Mosquitto configuration file is present
  template: src=mosquitto.conf.j2 dest=/etc/mosquitto/mosquitto.conf
  register: _mosquitto_config_file

# Sets the `_mosquitto_passwords_changed` fact
- import_tasks: password_change_detection.yml

- name: Delete the existing password file
  file: path="/etc/mosquitto/passwd" state=absent
  when: _mosquitto_passwords_changed

- name: Start with an empty password file
  file: path="/etc/mosquitto/passwd" state=touch
  when: _mosquitto_passwords_changed

- name: Write the temporary password file contents
  command: "docker run --rm -v /etc/mosquitto/passwd:/mosquitto/config/passwd eclipse-mosquitto:{{ mosquitto_docker_version }} mosquitto_passwd -b /mosquitto/config/passwd {{ item.name }} {{ item.password }}"
  with_items: "{{ mosquitto_users }}"
  when: _mosquitto_passwords_changed
  no_log: True

- name: Define the list of Docker volumes
  set_fact:
    _mosquitto_docker_volumes:
      - "/etc/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf"
      - "/opt/mosquitto/data:/mosquitto/data"
      - "/var/log/mosquitto:/mosquitto/log"
      - "/etc/mosquitto/passwd:/mosquitto/config/passwd"

- name: Add the certificate file directory to the list of volumes, if necessary
  set_fact:
    _mosquitto_docker_volumes: "{{ _mosquitto_docker_volumes }} + [ '{{ mosquitto_certfiles_dir }}:/mosquitto/certs' ]"
  when: mosquitto_use_ssl

- name: Ensure the Mosquitto Docker container is running
  docker_container:
    name: mosquitto
    image: "eclipse-mosquitto:{{ mosquitto_docker_version }}"
    restart: "{{ _mosquitto_passwords_changed or _mosquitto_config_file.changed }}"
    restart_policy: always
    ports:
      - "1883:1883"
      - "8883:8883"
    volumes: "{{ _mosquitto_docker_volumes }}"
